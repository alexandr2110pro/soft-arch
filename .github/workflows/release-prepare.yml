name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: true
        type: boolean

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  # Use default registry configuration (will be local verdaccio)
  # This workflow only prepares the release, doesn't publish

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full git history for conventional commits analysis
          fetch-depth: 0
          # Use PAT to trigger subsequent workflows
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.8.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Nx Release (Dry Run)
        if: ${{ inputs.dry-run == true }}
        run: |
          echo "ðŸ§ª Running in DRY RUN mode..."
          echo "This will show what would happen without making actual changes."
          pnpm dlx nx release --dry-run --verbose

      - name: Run Nx Release (Actual)
        if: ${{ inputs.dry-run == false }}
        run: |
          echo "ðŸš€ Running ACTUAL release..."
          echo "This will:"
          echo "  âœ… Analyze commit history since last release"
          echo "  âœ… Determine version bump (patch/minor/major)"
          echo "  âœ… Update all package.json files with new version"
          echo "  âœ… Generate/update CHANGELOG.md"
          echo "  âœ… Create release commit and git tag"
          echo "  âœ… Push changes and tag to GitHub"
          echo "  âœ… Create GitHub release (triggers publish workflow)"
          echo ""
          pnpm dlx nx release --verbose

      - name: Release Summary
        if: ${{ inputs.dry-run == false }}
        run: |
          echo "âœ… Release preparation completed!"
          echo "ðŸŽ¯ Next steps:"
          echo "  1. GitHub release created automatically"
          echo "  2. Publish workflow will trigger and publish to npm"
          echo "  3. Check Actions tab for publish workflow status" 